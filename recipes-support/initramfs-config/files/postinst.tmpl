#!/bin/sh
if [ -d /usr/share/secureboot ]; then
    patch -s -p0 /usr/share/initramfs-tools/scripts/local /usr/share/secureboot/secure-boot-debian-local.patch
fi

INITRAMFS_CONF=/etc/initramfs-tools/initramfs.conf
if [ -f ${INITRAMFS_CONF} ]; then
    sed -i -E 's/(^MODULES=).*/\1${INITRAMFS_MODULES}/' ${INITRAMFS_CONF}
    sed -i -E 's/(^BUSYBOX=).*/\1${INITRAMFS_BUSYBOX}/' ${INITRAMFS_CONF}
    sed -i -E 's/(^COMPRESS=).*/\1${INITRAMFS_COMPRESS}/' ${INITRAMFS_CONF}
    sed -i -E 's/(^KEYMAP=).*/\1${INITRAMFS_KEYMAP}/' ${INITRAMFS_CONF}
    sed -i -E 's/(^DEVICE=).*/\1${INITRAMFS_NET_DEVICE}/' ${INITRAMFS_CONF}
    sed -i -E 's/(^NFSROOT=).*/\1${INITRAMFS_NFSROOT}/' ${INITRAMFS_CONF}
    sed -i -E 's/(^RUNSIZE=).*/\1${INITRAMFS_RUNSIZE}/' ${INITRAMFS_CONF}
    if grep -Fxq "ROOT=" "${INITRAMFS_CONF}"; then
        sed -i -E 's/(^ROOT=).*/\1${INITRAMFS_ROOT}/' ${INITRAMFS_CONF}
    else
        sed -i -E "\$aROOT=${INITRAMFS_ROOT}" ${INITRAMFS_CONF}
    fi
fi

MODULES_LIST_FILE=/etc/initramfs-tools/modules
if [ -f ${MODULES_LIST_FILE} ]; then
    for modname in ${INITRAMFS_MODULE_LIST}; do
        if ! grep -Fxq "$modname" "${MODULES_LIST_FILE}"; then
            echo "$modname" >> "${MODULES_LIST_FILE}"
        fi
    done
fi

update-initramfs -v -u
